{"version":3,"file":"executeSale.cjs","sources":["../../../../src/plugins/auctionHouseModule/executeSale.ts"],"sourcesContent":["import {\n  ConfirmOptions,\n  PublicKey,\n  SYSVAR_INSTRUCTIONS_PUBKEY,\n} from '@solana/web3.js';\nimport type { Metaplex } from '@/Metaplex';\nimport { TransactionBuilder, Option } from '@/utils';\nimport {\n  createAuctioneerExecuteSaleInstruction,\n  createExecuteSaleInstruction,\n  createPrintPurchaseReceiptInstruction,\n} from '@metaplex-foundation/mpl-auction-house';\nimport {\n  useOperation,\n  Operation,\n  OperationHandler,\n  Pda,\n  lamports,\n  Signer,\n  SolAmount,\n  SplTokenAmount,\n  amount,\n  isSigner,\n} from '@/types';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport { findAssociatedTokenAccountPda } from '../tokenModule';\nimport { AuctionHouse } from './AuctionHouse';\nimport {\n  findAuctionHouseBuyerEscrowPda,\n  findAuctionHouseProgramAsSignerPda,\n  findAuctionHouseTradeStatePda,\n  findPurchaseReceiptPda,\n  findAuctioneerPda,\n} from './pdas';\nimport { Bid } from './Bid';\nimport { Listing } from './Listing';\nimport {\n  AuctioneerAuthorityRequiredError,\n  BidAndListingHaveDifferentAuctionHousesError,\n  BidAndListingHaveDifferentMintsError,\n  CanceledBidIsNotAllowedError,\n  CanceledListingIsNotAllowedError,\n} from './errors';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'ExecuteSaleOperation' as const;\n\n/**\n * @group Operations\n * @category Constructors\n */\nexport const executeSaleOperation = useOperation<ExecuteSaleOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type ExecuteSaleOperation = Operation<\n  typeof Key,\n  ExecuteSaleInput,\n  ExecuteSaleOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type ExecuteSaleInput = {\n  auctionHouse: AuctionHouse;\n  auctioneerAuthority?: Signer; // Use Auctioneer ix when provided\n  listing: Listing;\n  bid: Bid;\n  bookkeeper?: Signer; // Default: identity\n  printReceipt?: boolean; // Default: true\n\n  // Options.\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type ExecuteSaleOutput = {\n  response: SendAndConfirmTransactionResponse;\n  sellerTradeState: PublicKey;\n  buyerTradeState: PublicKey;\n  buyer: PublicKey;\n  seller: PublicKey;\n  metadata: PublicKey;\n  bookkeeper: Option<PublicKey>;\n  receipt: Option<Pda>;\n  price: SolAmount | SplTokenAmount;\n  tokens: SplTokenAmount;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const executeSaleOperationHandler: OperationHandler<ExecuteSaleOperation> =\n  {\n    handle: async (operation: ExecuteSaleOperation, metaplex: Metaplex) =>\n      executeSaleBuilder(metaplex, operation.input).sendAndConfirm(\n        metaplex,\n        operation.input.confirmOptions\n      ),\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type ExecuteSaleBuilderParams = Omit<\n  ExecuteSaleInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type ExecuteSaleBuilderContext = Omit<ExecuteSaleOutput, 'response'>;\n\n/**\n * @group Transaction Builders\n * @category Constructors\n */\nexport const executeSaleBuilder = (\n  metaplex: Metaplex,\n  params: ExecuteSaleBuilderParams\n): TransactionBuilder<ExecuteSaleBuilderContext> => {\n  const { auctionHouse, listing, bid, auctioneerAuthority } = params;\n  const { sellerAddress, asset } = listing;\n  const { buyerAddress, tokens } = bid;\n\n  if (!listing.auctionHouse.address.equals(bid.auctionHouse.address)) {\n    throw new BidAndListingHaveDifferentAuctionHousesError();\n  }\n  if (!listing.asset.address.equals(bid.asset.address)) {\n    throw new BidAndListingHaveDifferentMintsError();\n  }\n  if (bid.canceledAt) {\n    throw new CanceledBidIsNotAllowedError();\n  }\n  if (listing.canceledAt) {\n    throw new CanceledListingIsNotAllowedError();\n  }\n  if (auctionHouse.hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  // Data.\n  const price = auctionHouse.isNative\n    ? lamports(bid.price.basisPoints)\n    : amount(bid.price.basisPoints, auctionHouse.treasuryMint.currency);\n\n  // Accounts.\n  const sellerPaymentReceiptAccount = auctionHouse.isNative\n    ? sellerAddress\n    : findAssociatedTokenAccountPda(\n        auctionHouse.treasuryMint.address,\n        sellerAddress\n      );\n  const buyerReceiptTokenAccount = findAssociatedTokenAccountPda(\n    asset.address,\n    buyerAddress\n  );\n  const escrowPayment = findAuctionHouseBuyerEscrowPda(\n    auctionHouse.address,\n    buyerAddress\n  );\n  const freeTradeState = findAuctionHouseTradeStatePda(\n    auctionHouse.address,\n    sellerAddress,\n    auctionHouse.treasuryMint.address,\n    asset.address,\n    lamports(0).basisPoints,\n    tokens.basisPoints,\n    asset.token.address\n  );\n  const programAsSigner = findAuctionHouseProgramAsSignerPda();\n\n  const accounts = {\n    buyer: buyerAddress,\n    seller: sellerAddress,\n    tokenAccount: asset.token.address,\n    tokenMint: asset.address,\n    metadata: asset.metadataAddress,\n    treasuryMint: auctionHouse.treasuryMint.address,\n    escrowPaymentAccount: escrowPayment,\n    sellerPaymentReceiptAccount,\n    buyerReceiptTokenAccount,\n    authority: auctionHouse.authorityAddress,\n    auctionHouse: auctionHouse.address,\n    auctionHouseFeeAccount: auctionHouse.feeAccountAddress,\n    auctionHouseTreasury: auctionHouse.treasuryAccountAddress,\n    buyerTradeState: bid.tradeStateAddress,\n    sellerTradeState: listing.tradeStateAddress,\n    freeTradeState,\n    programAsSigner,\n  };\n\n  // Args.\n  const args = {\n    freeTradeStateBump: freeTradeState.bump,\n    escrowPaymentBump: escrowPayment.bump,\n    programAsSignerBump: programAsSigner.bump,\n    buyerPrice: price.basisPoints,\n    tokenSize: tokens.basisPoints,\n  };\n\n  // Execute Sale Instruction\n  let executeSaleInstruction = createExecuteSaleInstruction(accounts, args);\n  if (auctioneerAuthority) {\n    executeSaleInstruction = createAuctioneerExecuteSaleInstruction(\n      {\n        ...accounts,\n        auctioneerAuthority: auctioneerAuthority.publicKey,\n        ahAuctioneerPda: findAuctioneerPda(\n          auctionHouse.address,\n          auctioneerAuthority.publicKey\n        ),\n      },\n      args\n    );\n  }\n\n  // Provide additional keys to pay royalties.\n  asset.creators.forEach(({ address }) => {\n    executeSaleInstruction.keys.push({\n      pubkey: address,\n      isWritable: true,\n      isSigner: false,\n    });\n\n    // Provide ATA to receive SPL token royalty if is not native SOL sale.\n    if (!auctionHouse.isNative) {\n      executeSaleInstruction.keys.push({\n        pubkey: findAssociatedTokenAccountPda(\n          auctionHouse.treasuryMint.address,\n          address\n        ),\n        isWritable: true,\n        isSigner: false,\n      });\n    }\n  });\n\n  // Signers.\n  const executeSaleSigners = [auctioneerAuthority].filter(isSigner);\n\n  // Receipt.\n  const shouldPrintReceipt =\n    (params.printReceipt ?? true) &&\n    Boolean(listing.receiptAddress && bid.receiptAddress);\n  const bookkeeper = params.bookkeeper ?? metaplex.identity();\n  const purchaseReceipt = findPurchaseReceiptPda(\n    listing.tradeStateAddress,\n    bid.tradeStateAddress\n  );\n\n  return (\n    TransactionBuilder.make<ExecuteSaleBuilderContext>()\n      .setContext({\n        sellerTradeState: listing.tradeStateAddress,\n        buyerTradeState: bid.tradeStateAddress,\n        buyer: buyerAddress,\n        seller: sellerAddress,\n        metadata: asset.metadataAddress,\n        bookkeeper: shouldPrintReceipt ? bookkeeper.publicKey : null,\n        receipt: shouldPrintReceipt ? purchaseReceipt : null,\n        price,\n        tokens,\n      })\n\n      // Execute Sale.\n      .add({\n        instruction: executeSaleInstruction,\n        signers: executeSaleSigners,\n        key: params.instructionKey ?? 'executeSale',\n      })\n\n      // Print the Purchase Receipt.\n      .when(shouldPrintReceipt, (builder) =>\n        builder.add({\n          instruction: createPrintPurchaseReceiptInstruction(\n            {\n              purchaseReceipt: purchaseReceipt,\n              listingReceipt: listing.receiptAddress as Pda,\n              bidReceipt: bid.receiptAddress as Pda,\n              bookkeeper: bookkeeper.publicKey,\n              instruction: SYSVAR_INSTRUCTIONS_PUBKEY,\n            },\n            { purchaseReceiptBump: purchaseReceipt.bump }\n          ),\n          signers: [bookkeeper],\n          key: 'printPurchaseReceipt',\n        })\n      )\n  );\n};\n"],"names":["Key","executeSaleOperation","useOperation","executeSaleOperationHandler","handle","operation","metaplex","executeSaleBuilder","input","sendAndConfirm","confirmOptions","params","auctionHouse","listing","bid","auctioneerAuthority","sellerAddress","asset","buyerAddress","tokens","address","equals","BidAndListingHaveDifferentAuctionHousesError","BidAndListingHaveDifferentMintsError","canceledAt","CanceledBidIsNotAllowedError","CanceledListingIsNotAllowedError","hasAuctioneer","AuctioneerAuthorityRequiredError","price","isNative","lamports","basisPoints","amount","treasuryMint","currency","sellerPaymentReceiptAccount","findAssociatedTokenAccountPda","buyerReceiptTokenAccount","escrowPayment","findAuctionHouseBuyerEscrowPda","freeTradeState","findAuctionHouseTradeStatePda","token","programAsSigner","findAuctionHouseProgramAsSignerPda","accounts","buyer","seller","tokenAccount","tokenMint","metadata","metadataAddress","escrowPaymentAccount","authority","authorityAddress","auctionHouseFeeAccount","feeAccountAddress","auctionHouseTreasury","treasuryAccountAddress","buyerTradeState","tradeStateAddress","sellerTradeState","args","freeTradeStateBump","bump","escrowPaymentBump","programAsSignerBump","buyerPrice","tokenSize","executeSaleInstruction","createExecuteSaleInstruction","createAuctioneerExecuteSaleInstruction","publicKey","ahAuctioneerPda","findAuctioneerPda","creators","forEach","keys","push","pubkey","isWritable","isSigner","executeSaleSigners","filter","shouldPrintReceipt","printReceipt","Boolean","receiptAddress","bookkeeper","identity","purchaseReceipt","findPurchaseReceiptPda","TransactionBuilder","make","setContext","receipt","add","instruction","signers","key","instructionKey","when","builder","createPrintPurchaseReceiptInstruction","listingReceipt","bidReceipt","SYSVAR_INSTRUCTIONS_PUBKEY","purchaseReceiptBump"],"mappings":"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"}