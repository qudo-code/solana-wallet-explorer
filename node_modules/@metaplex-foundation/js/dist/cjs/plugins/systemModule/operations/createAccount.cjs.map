{"version":3,"file":"createAccount.cjs","sources":["../../../../../src/plugins/systemModule/operations/createAccount.ts"],"sourcesContent":["import {\n  ConfirmOptions,\n  Keypair,\n  PublicKey,\n  SystemProgram,\n} from '@solana/web3.js';\nimport type { Metaplex } from '@/Metaplex';\nimport {\n  assertSol,\n  Operation,\n  OperationHandler,\n  Signer,\n  SolAmount,\n  useOperation,\n} from '@/types';\nimport { DisposableScope, TransactionBuilder } from '@/utils';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateAccountOperation' as const;\n\n/**\n * @group Operations\n * @category Constructors\n */\nexport const createAccountOperation = useOperation<CreateAccountOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateAccountOperation = Operation<\n  typeof Key,\n  CreateAccountInput,\n  CreateAccountOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateAccountInput = {\n  /** The space in bytes of the account to create. */\n  space: number;\n\n  /**\n   * The initial balance of the account.\n   * @defaultValue By default, this will be the minumum amount of lamports\n   * required for the account to be rent-exempt.\n   * i.e. it will be equal to `await metaplex.rpc().getRent(space)`.\n   */\n  lamports?: SolAmount;\n\n  /**\n   * The Signer to use to pay for the new account and the transaction fee.\n   * @defaultValue Defaults to the current identity, i.e. `metaplex.identity()`.\n   */\n  payer?: Signer;\n\n  /**\n   * The new account as a Signer since it will be mutated on-chain.\n   * @defaultValue Defaults to a new generated Keypair, i.e. `Keypair.generate()`.\n   */\n  newAccount?: Signer;\n\n  /**\n   * The address of the program that should own the new account.\n   * @defaultValue Defaults to the System Program.\n   */\n  program?: PublicKey;\n\n  /**\n   * The options to use when confirming the transaction.\n   * @defaultValue Defaults to `{}`.\n   */\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateAccountOutput = {\n  /** The response from sending and confirming the sent transaction. */\n  response: SendAndConfirmTransactionResponse;\n\n  /** The new account created as a Signer. */\n  newAccount: Signer;\n\n  /** The lamports used to initialize the account's balance. */\n  lamports: SolAmount;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createAccountOperationHandler: OperationHandler<CreateAccountOperation> =\n  {\n    async handle(\n      operation: CreateAccountOperation,\n      metaplex: Metaplex,\n      scope: DisposableScope\n    ): Promise<CreateAccountOutput> {\n      const builder = await createAccountBuilder(metaplex, operation.input);\n      scope.throwIfCanceled();\n      return builder.sendAndConfirm(metaplex, operation.input.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateAccountBuilderParams = Omit<\n  CreateAccountInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateAccountBuilderContext = Omit<CreateAccountOutput, 'response'>;\n\n/**\n * Note that accessing this transaction builder is asynchronous\n * because we may need to contact the cluster to get the\n * rent-exemption for the provided space.\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createAccountBuilder = async (\n  metaplex: Metaplex,\n  params: CreateAccountBuilderParams\n): Promise<TransactionBuilder<CreateAccountBuilderContext>> => {\n  const {\n    space,\n    payer = metaplex.identity(),\n    newAccount = Keypair.generate(),\n    program = SystemProgram.programId,\n  } = params;\n\n  const lamports = params.lamports ?? (await metaplex.rpc().getRent(space));\n  assertSol(lamports);\n\n  return TransactionBuilder.make<CreateAccountBuilderContext>()\n    .setFeePayer(payer)\n    .setContext({\n      newAccount,\n      lamports,\n    })\n    .add({\n      instruction: SystemProgram.createAccount({\n        fromPubkey: payer.publicKey,\n        newAccountPubkey: newAccount.publicKey,\n        space,\n        lamports: lamports.basisPoints.toNumber(),\n        programId: program,\n      }),\n      signers: [payer, newAccount],\n      key: params.instructionKey ?? 'createAccount',\n    });\n};\n"],"names":["Key","createAccountOperation","useOperation","createAccountOperationHandler","handle","operation","metaplex","scope","builder","createAccountBuilder","input","throwIfCanceled","sendAndConfirm","confirmOptions","params","space","payer","identity","newAccount","Keypair","generate","program","SystemProgram","programId","lamports","rpc","getRent","assertSol","TransactionBuilder","make","setFeePayer","setContext","add","instruction","createAccount","fromPubkey","publicKey","newAccountPubkey","basisPoints","toNumber","signers","key","instructionKey"],"mappings":";;;;;;;;;AAkBA;AACA;AACA;AAEA,MAAMA,GAAG,GAAG,wBAAZ,CAAA;AAEA;AACA;AACA;AACA;;MACaC,sBAAsB,GAAGC,sBAAY,CAAyBF,GAAzB,EAA3C;AAEP;AACA;AACA;AACA;;AA+DA;AACA;AACA;AACA;AACO,MAAMG,6BAAuE,GAClF;AACE,EAAA,MAAMC,MAAN,CACEC,SADF,EAEEC,QAFF,EAGEC,KAHF,EAIgC;IAC9B,MAAMC,OAAO,GAAG,MAAMC,oBAAoB,CAACH,QAAD,EAAWD,SAAS,CAACK,KAArB,CAA1C,CAAA;AACAH,IAAAA,KAAK,CAACI,eAAN,EAAA,CAAA;IACA,OAAOH,OAAO,CAACI,cAAR,CAAuBN,QAAvB,EAAiCD,SAAS,CAACK,KAAV,CAAgBG,cAAjD,CAAP,CAAA;AACD,GAAA;;AATH;AAaF;AACA;;AAEA;AACA;AACA;AACA;;AAcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;MACaJ,oBAAoB,GAAG,OAClCH,QADkC,EAElCQ,MAFkC,KAG2B;AAAA,EAAA,IAAA,gBAAA,EAAA,qBAAA,CAAA;;EAC7D,MAAM;IACJC,KADI;AAEJC,IAAAA,KAAK,GAAGV,QAAQ,CAACW,QAAT,EAFJ;AAGJC,IAAAA,UAAU,GAAGC,eAAO,CAACC,QAAR,EAHT;IAIJC,OAAO,GAAGC,qBAAa,CAACC,SAAAA;AAJpB,GAAA,GAKFT,MALJ,CAAA;AAOA,EAAA,MAAMU,QAAQ,GAAA,CAAA,gBAAA,GAAGV,MAAM,CAACU,QAAV,MAAuB,IAAA,IAAA,gBAAA,KAAA,KAAA,CAAA,GAAA,gBAAA,GAAA,MAAMlB,QAAQ,CAACmB,GAAT,EAAA,CAAeC,OAAf,CAAuBX,KAAvB,CAA3C,CAAA;EACAY,gBAAS,CAACH,QAAD,CAAT,CAAA;EAEA,OAAOI,qCAAkB,CAACC,IAAnB,EAAA,CACJC,WADI,CACQd,KADR,CAEJe,CAAAA,UAFI,CAEO;IACVb,UADU;AAEVM,IAAAA,QAAAA;GAJG,CAAA,CAMJQ,GANI,CAMA;AACHC,IAAAA,WAAW,EAAEX,qBAAa,CAACY,aAAd,CAA4B;MACvCC,UAAU,EAAEnB,KAAK,CAACoB,SADqB;MAEvCC,gBAAgB,EAAEnB,UAAU,CAACkB,SAFU;MAGvCrB,KAHuC;AAIvCS,MAAAA,QAAQ,EAAEA,QAAQ,CAACc,WAAT,CAAqBC,QAArB,EAJ6B;AAKvChB,MAAAA,SAAS,EAAEF,OAAAA;AAL4B,KAA5B,CADV;AAQHmB,IAAAA,OAAO,EAAE,CAACxB,KAAD,EAAQE,UAAR,CARN;AASHuB,IAAAA,GAAG,EAAE3B,CAAAA,qBAAAA,GAAAA,MAAM,CAAC4B,cAAT,MAA2B,IAAA,IAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,qBAAA,GAAA,eAAA;AAT3B,GANA,CAAP,CAAA;AAiBD;;;;;;"}