{"version":3,"file":"createListing.mjs","sources":["../../../../src/plugins/auctionHouseModule/createListing.ts"],"sourcesContent":["import {\n  ConfirmOptions,\n  PublicKey,\n  SYSVAR_INSTRUCTIONS_PUBKEY,\n} from '@solana/web3.js';\nimport {\n  createAuctioneerSellInstruction,\n  createPrintListingReceiptInstruction,\n  createSellInstruction,\n} from '@metaplex-foundation/mpl-auction-house';\nimport type { Metaplex } from '@/Metaplex';\nimport type { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport {\n  useOperation,\n  Operation,\n  OperationHandler,\n  Signer,\n  toPublicKey,\n  token,\n  lamports,\n  isSigner,\n  Pda,\n  amount,\n  SolAmount,\n  SplTokenAmount,\n} from '@/types';\nimport { TransactionBuilder, Option } from '@/utils';\nimport {\n  findAuctioneerPda,\n  findAuctionHouseProgramAsSignerPda,\n  findAuctionHouseTradeStatePda,\n  findListingReceiptPda,\n} from './pdas';\nimport { AuctionHouse } from './AuctionHouse';\nimport { findAssociatedTokenAccountPda } from '../tokenModule';\nimport { findMetadataPda } from '../nftModule';\nimport { AUCTIONEER_PRICE } from './constants';\nimport { AuctioneerAuthorityRequiredError } from './errors';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateListingOperation' as const;\n\n/**\n * @group Operations\n * @category Constructors\n */\nexport const createListingOperation = useOperation<CreateListingOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateListingOperation = Operation<\n  typeof Key,\n  CreateListingInput,\n  CreateListingOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateListingInput = {\n  auctionHouse: AuctionHouse;\n  seller?: PublicKey | Signer; // Default: identity\n  authority?: PublicKey | Signer; // Default: auctionHouse.authority\n  auctioneerAuthority?: Signer; // Use Auctioneer ix when provided\n  mintAccount: PublicKey; // Required for checking Metadata\n  tokenAccount?: PublicKey; // Default: ATA\n  price?: SolAmount | SplTokenAmount; // Default: 0 SOLs or tokens, ignored in Auctioneer.\n  tokens?: SplTokenAmount; // Default: token(1)\n  bookkeeper?: Signer; // Default: identity\n  printReceipt?: boolean; // Default: true\n\n  // Options.\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateListingOutput = {\n  response: SendAndConfirmTransactionResponse;\n  sellerTradeState: Pda;\n  freeSellerTradeState: Pda;\n  tokenAccount: PublicKey;\n  metadata: Pda;\n  seller: PublicKey;\n  receipt: Option<Pda>;\n  bookkeeper: Option<PublicKey>;\n  price: SolAmount | SplTokenAmount;\n  tokens: SplTokenAmount;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createListingOperationHandler: OperationHandler<CreateListingOperation> =\n  {\n    handle: async (operation: CreateListingOperation, metaplex: Metaplex) => {\n      return createListingBuilder(metaplex, operation.input).sendAndConfirm(\n        metaplex,\n        operation.input.confirmOptions\n      );\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateListingBuilderParams = Omit<\n  CreateListingInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateListingBuilderContext = Omit<CreateListingOutput, 'response'>;\n\n/**\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createListingBuilder = (\n  metaplex: Metaplex,\n  params: CreateListingBuilderParams\n): TransactionBuilder<CreateListingBuilderContext> => {\n  // Data.\n  const auctionHouse = params.auctionHouse;\n  const tokens = params.tokens ?? token(1);\n  const priceBasisPoint = params.auctioneerAuthority\n    ? AUCTIONEER_PRICE\n    : params.price?.basisPoints ?? 0;\n  const price = auctionHouse.isNative\n    ? lamports(priceBasisPoint)\n    : amount(priceBasisPoint, auctionHouse.treasuryMint.currency);\n\n  if (auctionHouse.hasAuctioneer && !params.auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  // Accounts.\n  const seller = params.seller ?? (metaplex.identity() as Signer);\n  const authority = params.authority ?? auctionHouse.authorityAddress;\n  const metadata = findMetadataPda(params.mintAccount);\n  const tokenAccount =\n    params.tokenAccount ??\n    findAssociatedTokenAccountPda(params.mintAccount, toPublicKey(seller));\n  const sellerTradeState = findAuctionHouseTradeStatePda(\n    auctionHouse.address,\n    toPublicKey(seller),\n    auctionHouse.treasuryMint.address,\n    params.mintAccount,\n    price.basisPoints,\n    tokens.basisPoints,\n    tokenAccount\n  );\n  const freeSellerTradeState = findAuctionHouseTradeStatePda(\n    auctionHouse.address,\n    toPublicKey(seller),\n    auctionHouse.treasuryMint.address,\n    params.mintAccount,\n    lamports(0).basisPoints,\n    tokens.basisPoints,\n    tokenAccount\n  );\n  const programAsSigner = findAuctionHouseProgramAsSignerPda();\n  const accounts = {\n    wallet: toPublicKey(seller),\n    tokenAccount,\n    metadata,\n    authority: toPublicKey(authority),\n    auctionHouse: auctionHouse.address,\n    auctionHouseFeeAccount: auctionHouse.feeAccountAddress,\n    sellerTradeState,\n    freeSellerTradeState,\n    programAsSigner,\n  };\n\n  // Args.\n  const args = {\n    tradeStateBump: sellerTradeState.bump,\n    freeTradeStateBump: freeSellerTradeState.bump,\n    programAsSignerBump: programAsSigner.bump,\n    buyerPrice: price.basisPoints,\n    tokenSize: tokens.basisPoints,\n  };\n\n  // Sell Instruction.\n  let sellInstruction;\n  if (params.auctioneerAuthority) {\n    sellInstruction = createAuctioneerSellInstruction(\n      {\n        ...accounts,\n        auctioneerAuthority: params.auctioneerAuthority.publicKey,\n        ahAuctioneerPda: findAuctioneerPda(\n          auctionHouse.address,\n          params.auctioneerAuthority.publicKey\n        ),\n      },\n      args\n    );\n  } else {\n    sellInstruction = createSellInstruction(accounts, args);\n  }\n\n  // Signers.\n  const sellSigners = [seller, authority, params.auctioneerAuthority].filter(\n    (input): input is Signer => !!input && isSigner(input)\n  );\n\n  // Receipt.\n  // Since createPrintListingReceiptInstruction can't deserialize createAuctioneerSellInstruction due to a bug\n  // Don't print Auctioneer Sell receipt for the time being.\n  const shouldPrintReceipt =\n    (params.printReceipt ?? true) && !params.auctioneerAuthority;\n  const bookkeeper = params.bookkeeper ?? metaplex.identity();\n  const receipt = findListingReceiptPda(sellerTradeState);\n\n  return (\n    TransactionBuilder.make<CreateListingBuilderContext>()\n      .setContext({\n        sellerTradeState,\n        freeSellerTradeState,\n        tokenAccount,\n        metadata,\n        seller: toPublicKey(seller),\n        receipt: shouldPrintReceipt ? receipt : null,\n        bookkeeper: shouldPrintReceipt ? bookkeeper.publicKey : null,\n        price,\n        tokens,\n      })\n\n      // Create Listing.\n      .add({\n        instruction: sellInstruction,\n        signers: sellSigners,\n        key: 'sell',\n      })\n\n      // Print the Listing Receipt.\n      .when(shouldPrintReceipt, (builder) =>\n        builder.add({\n          instruction: createPrintListingReceiptInstruction(\n            {\n              receipt,\n              bookkeeper: bookkeeper.publicKey,\n              instruction: SYSVAR_INSTRUCTIONS_PUBKEY,\n            },\n            { receiptBump: receipt.bump }\n          ),\n          signers: [bookkeeper],\n          key: 'printListingReceipt',\n        })\n      )\n  );\n};\n"],"names":["Key","createListingOperation","useOperation","createListingOperationHandler","handle","operation","metaplex","createListingBuilder","input","sendAndConfirm","confirmOptions","params","auctionHouse","tokens","token","priceBasisPoint","auctioneerAuthority","AUCTIONEER_PRICE","price","basisPoints","isNative","lamports","amount","treasuryMint","currency","hasAuctioneer","AuctioneerAuthorityRequiredError","seller","identity","authority","authorityAddress","metadata","findMetadataPda","mintAccount","tokenAccount","findAssociatedTokenAccountPda","toPublicKey","sellerTradeState","findAuctionHouseTradeStatePda","address","freeSellerTradeState","programAsSigner","findAuctionHouseProgramAsSignerPda","accounts","wallet","auctionHouseFeeAccount","feeAccountAddress","args","tradeStateBump","bump","freeTradeStateBump","programAsSignerBump","buyerPrice","tokenSize","sellInstruction","createAuctioneerSellInstruction","publicKey","ahAuctioneerPda","findAuctioneerPda","createSellInstruction","sellSigners","filter","isSigner","shouldPrintReceipt","printReceipt","bookkeeper","receipt","findListingReceiptPda","TransactionBuilder","make","setContext","add","instruction","signers","key","when","builder","createPrintListingReceiptInstruction","SYSVAR_INSTRUCTIONS_PUBKEY","receiptBump"],"mappings":"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"}