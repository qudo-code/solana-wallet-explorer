{"version":3,"file":"updateAuctionHouse.mjs","sources":["../../../../src/plugins/auctionHouseModule/updateAuctionHouse.ts"],"sourcesContent":["import { ConfirmOptions, PublicKey } from '@solana/web3.js';\nimport {\n  AuthorityScope,\n  createDelegateAuctioneerInstruction,\n  createUpdateAuctioneerInstruction,\n  createUpdateAuctionHouseInstruction,\n} from '@metaplex-foundation/mpl-auction-house';\nimport isEqual from 'lodash.isequal';\nimport type { Metaplex } from '@/Metaplex';\nimport { useOperation, Operation, Signer, OperationHandler } from '@/types';\nimport { TransactionBuilder } from '@/utils';\nimport { NoInstructionsToSendError } from '@/errors';\nimport { findAssociatedTokenAccountPda } from '../tokenModule';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport { assertAuctioneerAuctionHouse, AuctionHouse } from './AuctionHouse';\nimport { TreasuryDestinationOwnerRequiredError } from './errors';\nimport { findAuctioneerPda } from './pdas';\nimport { AUCTIONEER_ALL_SCOPES } from './constants';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'UpdateAuctionHouseOperation' as const;\n\n/**\n * @group Operations\n * @category Constructors\n */\nexport const updateAuctionHouseOperation =\n  useOperation<UpdateAuctionHouseOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type UpdateAuctionHouseOperation = Operation<\n  typeof Key,\n  UpdateAuctionHouseInput,\n  UpdateAuctionHouseOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type UpdateAuctionHouseInput = {\n  // Main Accounts.\n  auctionHouse: AuctionHouse;\n  authority?: Signer;\n  payer?: Signer;\n\n  // Updatable Data.\n  sellerFeeBasisPoints?: number | null;\n  requiresSignOff?: boolean | null;\n  canChangeSalePrice?: boolean | null;\n  newAuthority?: PublicKey;\n  feeWithdrawalDestination?: PublicKey;\n  treasuryWithdrawalDestinationOwner?: PublicKey;\n  auctioneerAuthority?: PublicKey;\n  auctioneerScopes?: AuthorityScope[];\n\n  // Options.\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type UpdateAuctionHouseOutput = {\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const updateAuctionHouseOperationHandler: OperationHandler<UpdateAuctionHouseOperation> =\n  {\n    handle: (operation: UpdateAuctionHouseOperation, metaplex: Metaplex) => {\n      const builder = updateAuctionHouseBuilder(metaplex, operation.input);\n\n      if (builder.isEmpty()) {\n        throw new NoInstructionsToSendError(Key);\n      }\n\n      return builder.sendAndConfirm(metaplex, operation.input.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type UpdateAuctionHouseBuilderParams = Omit<\n  UpdateAuctionHouseInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n  delegateAuctioneerInstructionKey?: string;\n  updateAuctioneerInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Constructors\n */\nexport const updateAuctionHouseBuilder = (\n  metaplex: Metaplex,\n  params: UpdateAuctionHouseBuilderParams\n): TransactionBuilder => {\n  const authority = params.authority ?? metaplex.identity();\n  const payer = params.payer ?? metaplex.identity();\n  const auctionHouse = params.auctionHouse;\n\n  let treasuryWithdrawalDestinationOwner: PublicKey;\n  let treasuryWithdrawalDestination: PublicKey;\n  if (auctionHouse.isNative) {\n    treasuryWithdrawalDestinationOwner =\n      params.treasuryWithdrawalDestinationOwner ??\n      auctionHouse.treasuryWithdrawalDestinationAddress;\n    treasuryWithdrawalDestination = treasuryWithdrawalDestinationOwner;\n  } else if (params.treasuryWithdrawalDestinationOwner) {\n    treasuryWithdrawalDestinationOwner =\n      params.treasuryWithdrawalDestinationOwner;\n    treasuryWithdrawalDestination = findAssociatedTokenAccountPda(\n      auctionHouse.treasuryMint.address,\n      treasuryWithdrawalDestinationOwner\n    );\n  } else {\n    throw new TreasuryDestinationOwnerRequiredError();\n  }\n\n  const originalData = {\n    authority: auctionHouse.authorityAddress,\n    feeWithdrawalDestination: auctionHouse.feeWithdrawalDestinationAddress,\n    treasuryWithdrawalDestination:\n      auctionHouse.treasuryWithdrawalDestinationAddress,\n    sellerFeeBasisPoints: auctionHouse.sellerFeeBasisPoints,\n    requiresSignOff: auctionHouse.requiresSignOff,\n    canChangeSalePrice: auctionHouse.canChangeSalePrice,\n  };\n  const updatedData = {\n    authority: params.newAuthority ?? originalData.authority,\n    feeWithdrawalDestination:\n      params.feeWithdrawalDestination ?? originalData.feeWithdrawalDestination,\n    treasuryWithdrawalDestination,\n    sellerFeeBasisPoints:\n      params.sellerFeeBasisPoints ?? originalData.sellerFeeBasisPoints,\n    requiresSignOff: params.requiresSignOff ?? originalData.requiresSignOff,\n    canChangeSalePrice:\n      params.canChangeSalePrice ?? originalData.canChangeSalePrice,\n  };\n\n  const shouldSendUpdateInstruction = !isEqual(originalData, updatedData);\n  const shouldAddAuctioneerAuthority =\n    !auctionHouse.hasAuctioneer && !!params.auctioneerAuthority;\n  const shouldUpdateAuctioneerAuthority =\n    auctionHouse.hasAuctioneer &&\n    !!params.auctioneerAuthority &&\n    !params.auctioneerAuthority.equals(auctionHouse.auctioneer.authority);\n  const shouldUpdateAuctioneerScopes =\n    auctionHouse.hasAuctioneer &&\n    !!params.auctioneerScopes &&\n    !isEqual(\n      params.auctioneerScopes.sort(),\n      auctionHouse.auctioneer.scopes.sort()\n    );\n  const shouldDelegateAuctioneer =\n    shouldAddAuctioneerAuthority || shouldUpdateAuctioneerAuthority;\n\n  return (\n    TransactionBuilder.make()\n      .setFeePayer(payer)\n\n      // Update the Auction House data.\n      .when(shouldSendUpdateInstruction, (builder) =>\n        builder.add({\n          instruction: createUpdateAuctionHouseInstruction(\n            {\n              treasuryMint: auctionHouse.treasuryMint.address,\n              payer: payer.publicKey,\n              authority: authority.publicKey,\n              newAuthority: updatedData.authority,\n              feeWithdrawalDestination: updatedData.feeWithdrawalDestination,\n              treasuryWithdrawalDestination,\n              treasuryWithdrawalDestinationOwner,\n              auctionHouse: auctionHouse.address,\n            },\n            {\n              sellerFeeBasisPoints: params.sellerFeeBasisPoints ?? null,\n              requiresSignOff: params.requiresSignOff ?? null,\n              canChangeSalePrice: params.canChangeSalePrice ?? null,\n            }\n          ),\n          signers: [payer, authority],\n          key: params.instructionKey ?? 'updateAuctionHouse',\n        })\n      )\n\n      // Attach or update a new Auctioneer instance to the Auction House.\n      .when(shouldDelegateAuctioneer, (builder) => {\n        const auctioneerAuthority = params.auctioneerAuthority as PublicKey;\n        const defaultScopes = auctionHouse.hasAuctioneer\n          ? auctionHouse.auctioneer.scopes\n          : AUCTIONEER_ALL_SCOPES;\n        return builder.add({\n          instruction: createDelegateAuctioneerInstruction(\n            {\n              auctionHouse: auctionHouse.address,\n              authority: authority.publicKey,\n              auctioneerAuthority,\n              ahAuctioneerPda: findAuctioneerPda(\n                auctionHouse.address,\n                auctioneerAuthority\n              ),\n            },\n            { scopes: params.auctioneerScopes ?? defaultScopes }\n          ),\n          signers: [authority],\n          key: params.delegateAuctioneerInstructionKey ?? 'delegateAuctioneer',\n        });\n      })\n\n      // Update the Auctioneer scopes of the Auction House.\n      .when(shouldUpdateAuctioneerScopes, (builder) => {\n        assertAuctioneerAuctionHouse(auctionHouse);\n        const auctioneerAuthority =\n          params.auctioneerAuthority ??\n          (auctionHouse.auctioneer.authority as PublicKey);\n        return builder.add({\n          instruction: createUpdateAuctioneerInstruction(\n            {\n              auctionHouse: auctionHouse.address,\n              authority: authority.publicKey,\n              auctioneerAuthority,\n              ahAuctioneerPda: findAuctioneerPda(\n                auctionHouse.address,\n                auctioneerAuthority\n              ),\n            },\n            {\n              scopes: params.auctioneerScopes ?? auctionHouse.auctioneer.scopes,\n            }\n          ),\n          signers: [authority],\n          key: params.updateAuctioneerInstructionKey ?? 'updateAuctioneer',\n        });\n      })\n  );\n};\n"],"names":["Key","updateAuctionHouseOperation","useOperation","updateAuctionHouseOperationHandler","handle","operation","metaplex","builder","updateAuctionHouseBuilder","input","isEmpty","NoInstructionsToSendError","sendAndConfirm","confirmOptions","params","authority","identity","payer","auctionHouse","treasuryWithdrawalDestinationOwner","treasuryWithdrawalDestination","isNative","treasuryWithdrawalDestinationAddress","findAssociatedTokenAccountPda","treasuryMint","address","TreasuryDestinationOwnerRequiredError","originalData","authorityAddress","feeWithdrawalDestination","feeWithdrawalDestinationAddress","sellerFeeBasisPoints","requiresSignOff","canChangeSalePrice","updatedData","newAuthority","shouldSendUpdateInstruction","isEqual","shouldAddAuctioneerAuthority","hasAuctioneer","auctioneerAuthority","shouldUpdateAuctioneerAuthority","equals","auctioneer","shouldUpdateAuctioneerScopes","auctioneerScopes","sort","scopes","shouldDelegateAuctioneer","TransactionBuilder","make","setFeePayer","when","add","instruction","createUpdateAuctionHouseInstruction","publicKey","signers","key","instructionKey","defaultScopes","AUCTIONEER_ALL_SCOPES","createDelegateAuctioneerInstruction","ahAuctioneerPda","findAuctioneerPda","delegateAuctioneerInstructionKey","assertAuctioneerAuctionHouse","createUpdateAuctioneerInstruction","updateAuctioneerInstructionKey"],"mappings":"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"}