{"version":3,"file":"createCandyMachine.mjs","sources":["../../../../../src/plugins/candyMachineModule/operations/createCandyMachine.ts"],"sourcesContent":["import { Metaplex } from '@/Metaplex';\nimport {\n  assertSameCurrencies,\n  isSigner,\n  Operation,\n  OperationHandler,\n  Signer,\n  SOL,\n  toBigNumber,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport {\n  DisposableScope,\n  Option,\n  RequiredKeys,\n  TransactionBuilder,\n} from '@/utils';\nimport {\n  createInitializeCandyMachineInstruction,\n  createSetCollectionInstruction,\n  Creator,\n} from '@metaplex-foundation/mpl-candy-machine';\nimport { ConfirmOptions, Keypair, PublicKey } from '@solana/web3.js';\nimport {\n  findCollectionAuthorityRecordPda,\n  findMasterEditionV2Pda,\n  findMetadataPda,\n  TokenMetadataProgram,\n} from '../../nftModule';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport {\n  CandyMachine,\n  CandyMachineConfigs,\n  toCandyMachineInstructionData,\n} from '../models/CandyMachine';\nimport { ExpectedSignerError } from '@/errors';\nimport { getCandyMachineAccountSizeFromData } from '../helpers';\nimport { findCandyMachineCollectionPda } from '../pdas';\nimport { CandyMachineProgram } from '../program';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateCandyMachineOperation' as const;\n\n/**\n * @group Operations\n * @category Constructors\n */\nexport const createCandyMachineOperation =\n  useOperation<CreateCandyMachineOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateCandyMachineOperation = Operation<\n  typeof Key,\n  CreateCandyMachineInput,\n  CreateCandyMachineOutput\n>;\n\nexport type CreateCandyMachineInputWithoutConfigs = {\n  // Accounts and Models.\n  candyMachine?: Signer; // Defaults to Keypair.generate().\n  payer?: Signer; // Defaults to mx.identity().\n  authority?: Signer | PublicKey; // Defaults to mx.identity().\n  collection?: Option<PublicKey>; // Defaults to no collection.\n\n  // Transaction Options.\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateCandyMachineInput = CreateCandyMachineInputWithoutConfigs &\n  RequiredKeys<\n    Partial<CandyMachineConfigs>,\n    'price' | 'sellerFeeBasisPoints' | 'itemsAvailable'\n  >;\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateCandyMachineOutput = {\n  response: SendAndConfirmTransactionResponse;\n  candyMachine: CandyMachine;\n  candyMachineSigner: Signer;\n  payer: Signer;\n  wallet: PublicKey;\n  authority: PublicKey;\n  creators: Creator[];\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createCandyMachineOperationHandler: OperationHandler<CreateCandyMachineOperation> =\n  {\n    async handle(\n      operation: CreateCandyMachineOperation,\n      metaplex: Metaplex,\n      scope: DisposableScope\n    ): Promise<CreateCandyMachineOutput> {\n      const builder = await createCandyMachineBuilder(\n        metaplex,\n        operation.input\n      );\n      scope.throwIfCanceled();\n\n      const output = await builder.sendAndConfirm(\n        metaplex,\n        operation.input.confirmOptions\n      );\n      scope.throwIfCanceled();\n\n      const candyMachine = await metaplex\n        .candyMachines()\n        .findByAddress({ address: output.candyMachineSigner.publicKey })\n        .run(scope);\n\n      return { ...output, candyMachine };\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateCandyMachineBuilderParams = Omit<\n  CreateCandyMachineInput,\n  'confirmOptions'\n> & {\n  createAccountInstructionKey?: string;\n  initializeCandyMachineInstructionKey?: string;\n  setCollectionInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateCandyMachineBuilderContext = Omit<\n  CreateCandyMachineOutput,\n  'response' | 'candyMachine'\n>;\n\n/**\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createCandyMachineBuilder = async (\n  metaplex: Metaplex,\n  params: CreateCandyMachineBuilderParams\n): Promise<TransactionBuilder<CreateCandyMachineBuilderContext>> => {\n  const candyMachine = params.candyMachine ?? Keypair.generate();\n  const payer: Signer = params.payer ?? metaplex.identity();\n  const authority = params.authority ?? metaplex.identity();\n  const collection: PublicKey | null = params.collection ?? null;\n\n  const { data, wallet, tokenMint } = toCandyMachineInstructionData(\n    candyMachine.publicKey,\n    {\n      ...params,\n      wallet: params.wallet ?? metaplex.identity().publicKey,\n      tokenMint: params.tokenMint ?? null,\n      symbol: params.symbol ?? '',\n      maxEditionSupply: params.maxEditionSupply ?? toBigNumber(0),\n      isMutable: params.isMutable ?? true,\n      retainAuthority: params.retainAuthority ?? true,\n      goLiveDate: params.goLiveDate ?? null,\n      endSettings: params.endSettings ?? null,\n      creators: params.creators ?? [\n        {\n          address: metaplex.identity().publicKey,\n          share: 100,\n          verified: false,\n        },\n      ],\n      hiddenSettings: params.hiddenSettings ?? null,\n      whitelistMintSettings: params.whitelistMintSettings ?? null,\n      gatekeeper: params.gatekeeper ?? null,\n    }\n  );\n\n  const initializeInstruction = createInitializeCandyMachineInstruction(\n    {\n      candyMachine: candyMachine.publicKey,\n      wallet,\n      authority: toPublicKey(authority),\n      payer: payer.publicKey,\n    },\n    { data }\n  );\n\n  if (tokenMint) {\n    initializeInstruction.keys.push({\n      pubkey: tokenMint,\n      isWritable: false,\n      isSigner: false,\n    });\n  } else {\n    assertSameCurrencies(params.price, SOL);\n  }\n\n  return (\n    TransactionBuilder.make<CreateCandyMachineBuilderContext>()\n      .setFeePayer(payer)\n      .setContext({\n        candyMachineSigner: candyMachine,\n        payer,\n        wallet,\n        authority: toPublicKey(authority),\n        creators: data.creators,\n      })\n\n      // Create an empty account for the candy machine.\n      .add(\n        await metaplex\n          .system()\n          .builders()\n          .createAccount({\n            payer,\n            newAccount: candyMachine,\n            space: getCandyMachineAccountSizeFromData(data),\n            program: CandyMachineProgram.publicKey,\n            instructionKey:\n              params.createAccountInstructionKey ?? 'createAccount',\n          })\n      )\n\n      // Initialize the candy machine account.\n      .add({\n        instruction: initializeInstruction,\n        signers: [candyMachine, payer],\n        key:\n          params.initializeCandyMachineInstructionKey ??\n          'initializeCandyMachine',\n      })\n\n      // Set the collection.\n      .when(!!collection, (builder) => {\n        if (!isSigner(authority)) {\n          throw new ExpectedSignerError('authority', 'PublicKey', {\n            problemSuffix:\n              'You are trying to create a Candy Machine with a Collection NFT. ' +\n              'In order for the Collection NFT to be set successfully, you must provide the authority as a Signer.',\n            solution:\n              'Please provide the \"authority\" parameter as a Signer if you want to set the Collection NFT upon creation. ' +\n              'Alternatively, you may remove the \"collection\" parameter to create a Candy Machine without an associated Collection NFT.',\n          });\n        }\n\n        const collectionMint = collection as PublicKey;\n        const metadata = findMetadataPda(collectionMint);\n        const edition = findMasterEditionV2Pda(collectionMint);\n        const collectionPda = findCandyMachineCollectionPda(\n          candyMachine.publicKey\n        );\n        const collectionAuthorityRecord = findCollectionAuthorityRecordPda(\n          collectionMint,\n          collectionPda\n        );\n\n        return builder.add({\n          instruction: createSetCollectionInstruction({\n            candyMachine: candyMachine.publicKey,\n            authority: toPublicKey(authority),\n            collectionPda,\n            payer: payer.publicKey,\n            metadata,\n            mint: collectionMint,\n            edition,\n            collectionAuthorityRecord,\n            tokenMetadataProgram: TokenMetadataProgram.publicKey,\n          }),\n          signers: [authority],\n          key: params.setCollectionInstructionKey ?? 'setCollection',\n        });\n      })\n  );\n};\n"],"names":["Key","createCandyMachineOperation","useOperation","createCandyMachineOperationHandler","handle","operation","metaplex","scope","builder","createCandyMachineBuilder","input","throwIfCanceled","output","sendAndConfirm","confirmOptions","candyMachine","candyMachines","findByAddress","address","candyMachineSigner","publicKey","run","params","Keypair","generate","payer","identity","authority","collection","data","wallet","tokenMint","toCandyMachineInstructionData","symbol","maxEditionSupply","toBigNumber","isMutable","retainAuthority","goLiveDate","endSettings","creators","share","verified","hiddenSettings","whitelistMintSettings","gatekeeper","initializeInstruction","createInitializeCandyMachineInstruction","toPublicKey","keys","push","pubkey","isWritable","isSigner","assertSameCurrencies","price","SOL","TransactionBuilder","make","setFeePayer","setContext","add","system","builders","createAccount","newAccount","space","getCandyMachineAccountSizeFromData","program","CandyMachineProgram","instructionKey","createAccountInstructionKey","instruction","signers","key","initializeCandyMachineInstructionKey","when","ExpectedSignerError","problemSuffix","solution","collectionMint","metadata","findMetadataPda","edition","findMasterEditionV2Pda","collectionPda","findCandyMachineCollectionPda","collectionAuthorityRecord","findCollectionAuthorityRecordPda","createSetCollectionInstruction","mint","tokenMetadataProgram","TokenMetadataProgram","setCollectionInstructionKey"],"mappings":"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"}