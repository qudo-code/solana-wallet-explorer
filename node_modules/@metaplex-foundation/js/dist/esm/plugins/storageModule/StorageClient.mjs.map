{"version":3,"file":"StorageClient.mjs","sources":["../../../../src/plugins/storageModule/StorageClient.ts"],"sourcesContent":["import { DriverNotProvidedError, InvalidJsonStringError } from '@/errors';\nimport { HasDriver, Amount } from '@/types';\nimport {\n  getBytesFromMetaplexFiles,\n  MetaplexFile,\n  toMetaplexFile,\n  toMetaplexFileFromJson,\n} from './MetaplexFile';\nimport { StorageDriver, StorageDownloadOptions } from './StorageDriver';\n\n/**\n * @group Modules\n */\nexport class StorageClient implements HasDriver<StorageDriver> {\n  private _driver: StorageDriver | null = null;\n\n  driver(): StorageDriver {\n    if (!this._driver) {\n      throw new DriverNotProvidedError('StorageDriver');\n    }\n\n    return this._driver;\n  }\n\n  setDriver(newDriver: StorageDriver): void {\n    this._driver = newDriver;\n  }\n\n  getUploadPriceForBytes(bytes: number): Promise<Amount> {\n    return this.driver().getUploadPrice(bytes);\n  }\n\n  getUploadPriceForFile(file: MetaplexFile): Promise<Amount> {\n    return this.getUploadPriceForFiles([file]);\n  }\n\n  getUploadPriceForFiles(files: MetaplexFile[]): Promise<Amount> {\n    return this.getUploadPriceForBytes(getBytesFromMetaplexFiles(...files));\n  }\n\n  upload(file: MetaplexFile): Promise<string> {\n    return this.driver().upload(file);\n  }\n\n  uploadAll(files: MetaplexFile[]): Promise<string[]> {\n    const driver = this.driver();\n\n    return driver.uploadAll\n      ? driver.uploadAll(files)\n      : Promise.all(files.map((file) => this.driver().upload(file)));\n  }\n\n  uploadJson<T extends object = object>(json: T): Promise<string> {\n    return this.upload(toMetaplexFileFromJson<T>(json));\n  }\n\n  async download(\n    uri: string,\n    options?: StorageDownloadOptions\n  ): Promise<MetaplexFile> {\n    const driver = this.driver();\n\n    if (driver.download) {\n      return driver.download(uri, options);\n    }\n\n    const response = await fetch(uri, options as RequestInit);\n    const buffer = await response.arrayBuffer();\n\n    return toMetaplexFile(buffer, uri);\n  }\n\n  async downloadJson<T extends object = object>(\n    uri: string,\n    options?: StorageDownloadOptions\n  ): Promise<T> {\n    const file = await this.download(uri, options);\n\n    try {\n      return JSON.parse(file.buffer.toString());\n    } catch (error) {\n      throw new InvalidJsonStringError({ cause: error as Error });\n    }\n  }\n}\n"],"names":["StorageClient","driver","_driver","DriverNotProvidedError","setDriver","newDriver","getUploadPriceForBytes","bytes","getUploadPrice","getUploadPriceForFile","file","getUploadPriceForFiles","files","getBytesFromMetaplexFiles","upload","uploadAll","Promise","all","map","uploadJson","json","toMetaplexFileFromJson","download","uri","options","response","fetch","buffer","arrayBuffer","toMetaplexFile","downloadJson","JSON","parse","toString","error","InvalidJsonStringError","cause"],"mappings":";;;;AAUA;AACA;AACA;AACO,MAAMA,aAAN,CAAwD;AAAA,EAAA,WAAA,GAAA;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,SAAA,EACrB,IADqB,CAAA,CAAA;AAAA,GAAA;;AAG7DC,EAAAA,MAAM,GAAkB;IACtB,IAAI,CAAC,IAAKC,CAAAA,OAAV,EAAmB;AACjB,MAAA,MAAM,IAAIC,sBAAJ,CAA2B,eAA3B,CAAN,CAAA;AACD,KAAA;;AAED,IAAA,OAAO,KAAKD,OAAZ,CAAA;AACD,GAAA;;EAEDE,SAAS,CAACC,SAAD,EAAiC;IACxC,IAAKH,CAAAA,OAAL,GAAeG,SAAf,CAAA;AACD,GAAA;;EAEDC,sBAAsB,CAACC,KAAD,EAAiC;AACrD,IAAA,OAAO,KAAKN,MAAL,EAAA,CAAcO,cAAd,CAA6BD,KAA7B,CAAP,CAAA;AACD,GAAA;;EAEDE,qBAAqB,CAACC,IAAD,EAAsC;AACzD,IAAA,OAAO,KAAKC,sBAAL,CAA4B,CAACD,IAAD,CAA5B,CAAP,CAAA;AACD,GAAA;;EAEDC,sBAAsB,CAACC,KAAD,EAAyC;IAC7D,OAAO,IAAA,CAAKN,sBAAL,CAA4BO,yBAAyB,CAAC,GAAGD,KAAJ,CAArD,CAAP,CAAA;AACD,GAAA;;EAEDE,MAAM,CAACJ,IAAD,EAAsC;AAC1C,IAAA,OAAO,KAAKT,MAAL,EAAA,CAAca,MAAd,CAAqBJ,IAArB,CAAP,CAAA;AACD,GAAA;;EAEDK,SAAS,CAACH,KAAD,EAA2C;AAClD,IAAA,MAAMX,MAAM,GAAG,IAAKA,CAAAA,MAAL,EAAf,CAAA;AAEA,IAAA,OAAOA,MAAM,CAACc,SAAP,GACHd,MAAM,CAACc,SAAP,CAAiBH,KAAjB,CADG,GAEHI,OAAO,CAACC,GAAR,CAAYL,KAAK,CAACM,GAAN,CAAWR,IAAD,IAAU,IAAA,CAAKT,MAAL,EAAA,CAAca,MAAd,CAAqBJ,IAArB,CAApB,CAAZ,CAFJ,CAAA;AAGD,GAAA;;EAEDS,UAAU,CAA4BC,IAA5B,EAAsD;AAC9D,IAAA,OAAO,KAAKN,MAAL,CAAYO,sBAAsB,CAAID,IAAJ,CAAlC,CAAP,CAAA;AACD,GAAA;;AAEa,EAAA,MAARE,QAAQ,CACZC,GADY,EAEZC,OAFY,EAGW;AACvB,IAAA,MAAMvB,MAAM,GAAG,IAAKA,CAAAA,MAAL,EAAf,CAAA;;IAEA,IAAIA,MAAM,CAACqB,QAAX,EAAqB;AACnB,MAAA,OAAOrB,MAAM,CAACqB,QAAP,CAAgBC,GAAhB,EAAqBC,OAArB,CAAP,CAAA;AACD,KAAA;;IAED,MAAMC,QAAQ,GAAG,MAAMC,KAAK,CAACH,GAAD,EAAMC,OAAN,CAA5B,CAAA;AACA,IAAA,MAAMG,MAAM,GAAG,MAAMF,QAAQ,CAACG,WAAT,EAArB,CAAA;AAEA,IAAA,OAAOC,cAAc,CAACF,MAAD,EAASJ,GAAT,CAArB,CAAA;AACD,GAAA;;AAEiB,EAAA,MAAZO,YAAY,CAChBP,GADgB,EAEhBC,OAFgB,EAGJ;IACZ,MAAMd,IAAI,GAAG,MAAM,IAAA,CAAKY,QAAL,CAAcC,GAAd,EAAmBC,OAAnB,CAAnB,CAAA;;IAEA,IAAI;MACF,OAAOO,IAAI,CAACC,KAAL,CAAWtB,IAAI,CAACiB,MAAL,CAAYM,QAAZ,EAAX,CAAP,CAAA;KADF,CAEE,OAAOC,KAAP,EAAc;MACd,MAAM,IAAIC,sBAAJ,CAA2B;AAAEC,QAAAA,KAAK,EAAEF,KAAAA;AAAT,OAA3B,CAAN,CAAA;AACD,KAAA;AACF,GAAA;;AAtE4D;;;;"}